name: Build and Test
on: push
jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 23, 24-ea ]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Cache Maven artifacts
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v3
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test
      - name: Package JAR
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/us/17033-azure-gh-pipeline'
        run: mvn -B package -DskipTests
      - name: Upload JAR Artifact
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/us/17033-azure-gh-pipeline'
        uses: actions/upload-artifact@v4
        with:
          name: graphhopper-jar-${{ matrix.java-version }}
          path: web-bundle/target/*.jar
          retention-days: 90

  # Push to Azure DevOps
  push-to-azure:
    runs-on: ubuntu-22.04
    needs: build
    # Run on master or test branch
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/test-azure-push'
    steps:
      - name: Set dry-run mode
        id: config
        run: |
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "dry_run=false" >> $GITHUB_OUTPUT
            echo "Running in PRODUCTION mode - PR will be created"
          else
            echo "dry_run=true" >> $GITHUB_OUTPUT
            echo "Running in DRY-RUN mode - No PR will be created (testing only)"
          fi

      - name: Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: graphhopper-jar-23  # Use Java 23 build
          path: ./artifacts

      - name: Get JAR info and set date
        id: jar-info
        run: |
          JAR_FILE=$(ls ./artifacts/*.jar | head -n 1)
          JAR_NAME=$(basename $JAR_FILE)
          DATE=$(date +%Y%m%d-%H%M%S)
          echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_NAME"

      - name: Clone Azure DevOps repo and create branch
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZURE_ORG: trihydro
          AZURE_PROJECT: SDX
          AZURE_REPO: graphhopper
        run: |
          echo "Authenticating with Azure DevOps"
          
          # Clone the Azure DevOps repo
          git clone https://$AZURE_DEVOPS_PAT@dev.azure.com/$AZURE_ORG/$AZURE_PROJECT/_git/$AZURE_REPO azure-repo
          
          if [ $? -eq 0 ]; then
            echo "Successfully cloned Azure DevOps repository"
          else
            echo "Failed to clone repository - check your PAT and repository details"
            exit 1
          fi
          
          cd azure-repo
          
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions@users.noreply.github.com"
          
          # Create a new branch
          BRANCH_NAME="update-graphhopper-jar-${{ steps.jar-info.outputs.date }}"
          git checkout -b $BRANCH_NAME
          echo "Created branch: $BRANCH_NAME"
          
          # Create resources directory if it doesn't exist
          mkdir -p resources
          echo "Resources directory ready"
          
          # Rename existing JAR file if it exists
          if [ -f "resources/${{ steps.jar-info.outputs.jar_name }}" ]; then
            OLD_NAME="resources/${{ steps.jar-info.outputs.jar_name }}-old-${{ steps.jar-info.outputs.date }}"
            mv "resources/${{ steps.jar-info.outputs.jar_name }}" "$OLD_NAME"
            echo "Renamed existing JAR to: $(basename $OLD_NAME)"
          else
            echo " No existing JAR file found (this may be the first upload)"
          fi
          
          # Copy new JAR file
          cp ../${{ steps.jar-info.outputs.jar_file }} resources/
          echo "Copied new JAR file to resources/"
          
          # Show what changed
          echo ""
          echo "Changes to be committed:"
          git status --short
          
          # Determine mode for commit message
          if [ "${{ steps.config.outputs.dry_run }}" = "true" ]; then
            MODE="DRY-RUN (test)"
          else
            MODE="PRODUCTION"
          fi
          
          # Commit changes with multi-line message
          git add resources/
          git commit -m "Update GraphHopper JAR from GitHub build - ${{ steps.jar-info.outputs.date }}" \
                     -m "Built from commit: ${{ github.sha }}" \
                     -m "Java version: 23" \
                     -m "Mode: $MODE"
          
          echo "Changes committed"
          
          # Push the branch
          git push origin $BRANCH_NAME
          
          if [ $? -eq 0 ]; then
            echo "Successfully pushed branch to Azure DevOps"
          else
            echo "Failed to push branch"
            exit 1
          fi
          
          # Save branch name for PR creation
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          echo ""
          echo "======================================"
          echo "Summary:"
          echo "  Branch: $BRANCH_NAME"
          echo "  JAR: ${{ steps.jar-info.outputs.jar_name }}"
          echo "  Mode: $MODE"
          echo "======================================"

      - name: Create Pull Request in Azure DevOps
        if: steps.config.outputs.dry_run == 'false'
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZURE_ORG: your-org
          AZURE_PROJECT: your-project
          AZURE_REPO: your-repo
        run: |
          echo "Creating Pull Request in Azure DevOps..."
          
          # Create PR using Azure DevOps REST API
          PR_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n :$AZURE_DEVOPS_PAT | base64)" \
            -d "{
              \"sourceRefName\": \"refs/heads/${{ env.BRANCH_NAME }}\",
              \"targetRefName\": \"refs/heads/main\",
              \"title\": \"Update GraphHopper JAR - ${{ steps.jar-info.outputs.date }}\",
              \"description\": \"Automated PR to update GraphHopper JAR file.\\n\\n**Source:** GitHub repository\\n**Commit:** ${{ github.sha }}\\n**Java Version:** 23\\n**Build Date:** ${{ steps.jar-info.outputs.date }}\\n\\nThis JAR was automatically built and uploaded by GitHub Actions.\"
            }" \
            "https://dev.azure.com/$AZURE_ORG/$AZURE_PROJECT/_apis/git/repositories/$AZURE_REPO/pullrequests?api-version=7.0")
          
          PR_ID=$(echo $PR_RESPONSE | jq -r '.pullRequestId // empty')
          
          if [ -n "$PR_ID" ]; then
            echo "Pull Request created successfully!"
            echo "   PR ID: $PR_ID"
            echo "   URL: https://dev.azure.com/$AZURE_ORG/$AZURE_PROJECT/_git/$AZURE_REPO/pullrequest/$PR_ID"
          else
            echo "Failed to create Pull Request"
            echo "Response:"
            echo "$PR_RESPONSE" | jq .
            exit 1
          fi

      - name: Dry-run summary
        if: steps.config.outputs.dry_run == 'true'
        run: |
          echo ""
          echo "======================================"
          echo " DRY-RUN MODE SUMMARY"
          echo "======================================"
          echo ""
          echo "✅ Authentication: SUCCESS"
          echo "✅ Repository clone: SUCCESS"
          echo "✅ Branch creation: SUCCESS (${{ env.BRANCH_NAME }})"
          echo "✅ File operations: SUCCESS"
          echo "✅ Git commit: SUCCESS"
          echo "✅ Git push: SUCCESS"
          echo ""
          echo "======================================"
